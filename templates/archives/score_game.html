{% extends 'base.html' %}

{% block title %}Score a Game - Perfect Line Archives{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Game Show Scorekeeper</h1>
        <p class="text-md md:text-lg text-gray-400 mt-2">Track game results live as they happen.</p>
    </header>

    <!-- Episode Information -->
    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 mb-8 flex flex-col sm:flex-row items-center justify-center gap-6">
        <div class="flex items-center gap-3">
            <label for="episodeTitle" class="font-semibold text-lg">Title:</label>
            <input type="text" id="episodeTitle" class="bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div class="flex items-center gap-3">
            <label for="airDate" class="font-semibold text-lg">Air Date:</label>
            <input type="date" id="airDate" class="bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div class="flex items-center gap-4">
            <span class="font-semibold text-lg">Episode:</span>
            <div class="flex gap-3">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="episodeNumber" value="1" class="form-radio bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500" checked>
                    <span>1</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="episodeNumber" value="2" class="form-radio bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500">
                    <span>2</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Main Scorekeeping Grid -->
    <main id="scorecard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

        <!-- Player cards will be dynamically generated by JS, but this is the template -->
        <script id="player-card-template" type="text/template">
            <div class="player-card bg-gray-800 border border-gray-700 rounded-xl p-6 transition-all duration-200" data-player-id="{playerId}">
                <h2 class="text-2xl font-bold text-center mb-2">Podium {playerId}</h2>
                <input type="text" placeholder="Player Name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-center text-white mb-6 player-name">

                <!-- Rounds 1-4 -->
                <div class="mb-6">
                    <h3 class="section-title text-sm text-gray-400 font-semibold uppercase tracking-wider border-b border-gray-700 pb-2 mb-4">Rounds 1-4</h3>
                    <div class="space-y-3">
                        <button class="w-full py-2 rounded-md font-medium round-toggle border-2 border-gray-600 transition-colors" data-round="1">Round 1 Correct</button>
                        <button class="w-full py-2 rounded-md font-medium round-toggle border-2 border-gray-600 transition-colors" data-round="2">Round 2 Correct</button>
                        <button class="w-full py-2 rounded-md font-medium round-toggle border-2 border-gray-600 transition-colors" data-round="3">Round 3 Correct</button>
                        <button class="w-full py-2 rounded-md font-medium round-toggle border-2 border-gray-600 transition-colors" data-round="4">Round 4 Correct</button>
                    </div>
                    <input type="text" readonly class="w-full mt-4 rounded-md p-2 round-score score-input bg-gray-700 border border-gray-600 text-gray-300 text-lg text-center font-bold" placeholder="$0">
                </div>

                 <!-- Round Tie Breaker -->
                <div class="round-tie-breaker mt-6 hidden">
                    <h3 class="section-title text-sm border-yellow-500 text-yellow-400 font-semibold uppercase tracking-wider border-b pb-2 mb-4">TIE-BREAKER</h3>
                    <button class="w-full py-2 rounded-md font-bold text-gray-800 bg-yellow-400 hover:bg-yellow-500 round-tie-breaker-advance">Select Winner</button>
                </div>

                <!-- Fast Line -->
                <div class="mb-6">
                    <h3 class="section-title text-sm text-gray-400 font-semibold uppercase tracking-wider border-b border-gray-700 pb-2 mb-4">Fast Line</h3>
                    <p class="text-xs text-center text-gray-400 mb-2">Correct ($500 ea.)</p>
                    <div class="grid grid-cols-8 gap-1 mb-3 fast-line-correct">
                        <!-- Correct buttons 0-15 generated here -->
                    </div>
                    <p class="text-xs text-center text-gray-400 mb-2">Incorrect</p>
                    <div class="grid grid-cols-8 gap-1 fast-line-incorrect">
                        <!-- Incorrect buttons 0-15 generated here -->
                    </div>
                    <input type="text" readonly class="w-full mt-4 rounded-md p-2 fast-line-score score-input bg-gray-700 border border-gray-600 text-gray-300 text-lg text-center font-bold" placeholder="$0">
                </div>

                <!-- Fast Line Tie Breaker -->
                <div class="fast-line-tie-breaker mt-6 hidden">
                    <h3 class="section-title text-sm border-yellow-500 text-yellow-400 font-semibold uppercase tracking-wider border-b pb-2 mb-4">FAST LINE TIE-BREAKER</h3>
                    <button class="w-full py-2 rounded-md font-bold text-gray-800 bg-yellow-400 hover:bg-yellow-500 fast-line-tie-breaker-advance">Select Winner</button>
                </div>

                <!-- Final Round -->
                <div>
                    <h3 class="section-title text-sm text-gray-400 font-semibold uppercase tracking-wider border-b border-gray-700 pb-2 mb-4">Final Round</h3>
                    <p class="text-xs text-center text-gray-400 mb-2">Number Correct</p>
                    <div class="grid grid-cols-6 gap-1 final-round-correct">
                       <!-- Final round buttons 0-5 generated here -->
                    </div>
                    <input type="text" readonly class="w-full mt-4 rounded-md p-2 final-score score-input bg-gray-700 border border-gray-600 text-gray-300 text-lg text-center font-bold" placeholder="$0">
                </div>
            </div>
        </script>
    </main>

    <!-- Submit Button -->
    <footer class="text-center mt-8">
        <button id="submitBtn" class="submit-btn bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors">
            Submit Game Results
        </button>
        <p id="submitMessage" class="mt-2 h-6"></p>
    </footer>
</div>

<style>
    .player-card.advances {
        border-color: #10b981; /* Tailwind emerald-500 */
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
    }
    .round-toggle.correct {
        background-color: #10b981;
        border-color: #10b981;
        color: white;
        font-weight: 600;
    }
    .choice-btn {
        background-color: #374151;
        border: 1px solid #4b5563;
        transition: all 0.2s ease-in-out;
    }
    .choice-btn:hover {
        background-color: #4b5563;
    }
    .choice-btn.selected {
        background-color: #10b981;
        border-color: #10b981;
        color: white;
    }
    .choice-btn-red.selected {
        background-color: #ef4444; /* Tailwind red-500 */
        border-color: #ef4444;
        color: white;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const scorecard = document.getElementById('scorecard');
        const template = document.getElementById('player-card-template').innerHTML;

        const ROUND_VALUES = [2400, 3000, 3600, 4200];
        const FAST_LINE_VALUE = 500;
        const FINAL_ROUND_CONSOLATION = 1000;

        let roundTiebreakerWinnerId = null;
        let fastLineTiebreakerWinnerId = null;
        let playerScores = [];

        let players = Array.from({ length: 4 }, (_, i) => ({
            id: i + 1,
            name: '',
            rounds: [false, false, false, false],
            fastLineCorrect: -1,
            fastLineIncorrect: -1,
            finalRoundCorrect: -1,
        }));

        // --- INITIALIZATION ---
        function initialize() {
            scorecard.innerHTML = '';
            for (let i = 1; i <= 4; i++) {
                scorecard.insertAdjacentHTML('beforeend', template.replaceAll('{playerId}', i));
            }

            document.querySelectorAll('.player-card').forEach(card => {
                const fastLineCorrectContainer = card.querySelector('.fast-line-correct');
                const fastLineIncorrectContainer = card.querySelector('.fast-line-incorrect');
                const finalRoundContainer = card.querySelector('.final-round-correct');

                for (let i = 0; i <= 15; i++) {
                    const btnCorrect = document.createElement('button');
                    btnCorrect.className = 'w-7 h-7 rounded-full text-xs font-bold choice-btn';
                    btnCorrect.textContent = i;
                    btnCorrect.dataset.value = i;
                    btnCorrect.dataset.type = 'fast-line-correct';
                    fastLineCorrectContainer.appendChild(btnCorrect);

                    const btnIncorrect = document.createElement('button');
                    btnIncorrect.className = 'w-7 h-7 rounded-full text-xs font-bold choice-btn choice-btn-red';
                    btnIncorrect.textContent = i;
                    btnIncorrect.dataset.value = i;
                    btnIncorrect.dataset.type = 'fast-line-incorrect';
                    fastLineIncorrectContainer.appendChild(btnIncorrect);
                }
                for (let i = 0; i <= 5; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'w-full h-8 rounded-md text-sm font-bold choice-btn';
                    btn.textContent = i;
                    btn.dataset.value = i;
                    btn.dataset.type = 'final-round-correct';
                    finalRoundContainer.appendChild(btn);
                }
            });

            document.getElementById('airDate').valueAsDate = new Date();
            addEventListeners();
            updateAllScores();
        }

        // --- EVENT LISTENERS ---
        function addEventListeners() {
            scorecard.addEventListener('input', (e) => {
                if (e.target.classList.contains('player-name')) {
                    const playerId = e.target.closest('.player-card').dataset.playerId;
                    players[playerId - 1].name = e.target.value;
                }
            });

            scorecard.addEventListener('click', (e) => {
                const card = e.target.closest('.player-card');
                if (!card) return;
                const playerId = parseInt(card.dataset.playerId);

                if (e.target.classList.contains('round-toggle')) {
                    roundTiebreakerWinnerId = null;
                    fastLineTiebreakerWinnerId = null;
                    e.target.classList.toggle('correct');
                    const round = parseInt(e.target.dataset.round);
                    players[playerId - 1].rounds[round - 1] = e.target.classList.contains('correct');
                    updateAllScores();
                }

                if (e.target.classList.contains('round-tie-breaker-advance')) {
                    roundTiebreakerWinnerId = playerId;
                    updateAllScores();
                }

                if (e.target.classList.contains('fast-line-tie-breaker-advance')) {
                    fastLineTiebreakerWinnerId = playerId;
                    updateAllScores();
                }

                if (e.target.classList.contains('choice-btn')) {
                    fastLineTiebreakerWinnerId = null;
                    const type = e.target.dataset.type;
                    const value = parseInt(e.target.dataset.value);

                    if (type === 'fast-line-correct') players[playerId - 1].fastLineCorrect = value;
                    if (type === 'fast-line-incorrect') players[playerId - 1].fastLineIncorrect = value;
                    if (type === 'final-round-correct') players[playerId - 1].finalRoundCorrect = value;

                    e.target.parentElement.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    updateAllScores();
                }
            });

            document.getElementById('submitBtn').addEventListener('click', handleSubmit);
        }

        // --- SCORING LOGIC & UI UPDATES ---
        function updateAllScores() {
            // 1. Initialize scores object
            playerScores = [];
            players.forEach(p => {
                playerScores[p.id - 1] = {
                    round1: 0, round2: 0, round3: 0, round4: 0, roundTotal: 0,
                    fastLine: 0, fastLineScore: 0, total: 0, final: 0
                };
            });

            // 2. Calculate individual round scores
            for (let i = 0; i < 4; i++) {
                const correctPlayers = players.filter(p => p.rounds[i]);
                const numCorrect = correctPlayers.length;
                const roundValue = numCorrect > 0 ? ROUND_VALUES[i] / numCorrect : 0;
                const roundKey = `round${i + 1}`;
                players.forEach(p => {
                    if (p.rounds[i]) playerScores[p.id - 1][roundKey] = roundValue;
                });
            }

            // 3. Calculate round totals
            playerScores.forEach((score) => {
                score.roundTotal = score.round1 + score.round2 + score.round3 + score.round4;
            });

            // 4. Determine advancing players and handle ties
            const roundTotals = playerScores.map((s, i) => ({ score: s.roundTotal, id: i + 1 }));
            roundTotals.sort((a, b) => b.score - a.score);

            document.querySelectorAll('.round-tie-breaker').forEach(el => el.classList.add('hidden'));
            const score1 = roundTotals[0]?.score ?? -1;
            const score2 = roundTotals[1]?.score ?? -1;
            const score3 = roundTotals[2]?.score ?? -1;
            const isTieForSecond = score1 > score2 && score2 === score3 && score2 > 0;

            let advancingIds = [];
            if (score1 > 0) advancingIds.push(roundTotals[0].id);

            if (isTieForSecond) {
                const tiedPlayerIds = roundTotals.filter(p => p.score === score2).map(p => p.id);
                tiedPlayerIds.forEach(id => {
                    document.querySelector(`.player-card[data-player-id="${id}"] .round-tie-breaker`).classList.remove('hidden');
                });
                if (roundTiebreakerWinnerId && tiedPlayerIds.includes(roundTiebreakerWinnerId)) {
                    advancingIds.push(roundTiebreakerWinnerId);
                }
            } else {
                if (score2 > 0) advancingIds.push(roundTotals[1].id);
                if (!isTieForSecond) roundTiebreakerWinnerId = null;
            }

            // 5. Calculate Fast Line and Total Scores for everyone
            playerScores.forEach((score, i) => {
                if (players[i].fastLineCorrect > -1) {
                    score.fastLine = players[i].fastLineCorrect * FAST_LINE_VALUE;
                    score.fastLineScore = score.fastLine;
                }
                score.total = score.roundTotal + score.fastLine;
            });

            // 6. Determine Fast Line Tie & Winner
            document.querySelectorAll('.fast-line-tie-breaker').forEach(el => el.classList.add('hidden'));
            let fastLineTotals = [];
            advancingIds.forEach(id => {
                fastLineTotals.push({ score: playerScores[id - 1].total, id: id });
            });
            const isTieForFastLine = fastLineTotals.length === 2 && fastLineTotals[0].score === fastLineTotals[1].score && fastLineTotals[0].score > 0;

            let gameWinnerId = null;
            if (isTieForFastLine) {
                advancingIds.forEach(id => {
                    document.querySelector(`.player-card[data-player-id="${id}"] .fast-line-tie-breaker`).classList.remove('hidden');
                });
                if (fastLineTiebreakerWinnerId) {
                    gameWinnerId = fastLineTiebreakerWinnerId;
                }
            } else {
                fastLineTiebreakerWinnerId = null;
                if (fastLineTotals.length > 0) {
                    fastLineTotals.sort((a, b) => b.score - a.score);
                    gameWinnerId = fastLineTotals[0].id;
                }
            }

            // 7. Calculate Final Winnings (the prize money)
            playerScores.forEach((score, i) => {
                const player = players[i];
                const isWinner = player.id === gameWinnerId;

                if (isWinner) {
                    if (player.finalRoundCorrect > -1) {
                        // Final round has been played by the winner
                        score.final = player.finalRoundCorrect === 5 ? score.total : FINAL_ROUND_CONSOLATION;
                    } else {
                        // Final round not yet played, display potential winnings
                        score.final = score.total;
                    }
                } else {
                    // Any player who is not the final winner gets $0 prize money.
                    score.final = 0;
                }
            });

            // 8. Update UI
            document.querySelectorAll('.player-card').forEach(card => {
                card.classList.toggle('advances', advancingIds.includes(parseInt(card.dataset.playerId)));
            });

            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
            playerScores.forEach((scores, i) => {
                const card = document.querySelector(`.player-card[data-player-id="${i + 1}"]`);
                const playerId = i + 1;

                card.querySelector('.round-score').value = formatter.format(scores.roundTotal);
                card.querySelector('.fast-line-score').value = formatter.format(scores.total);
                card.querySelector('.final-score').value = formatter.format(scores.final);
            });
        }

        // --- FORM RESET ---
        function resetForm() {
            roundTiebreakerWinnerId = null;
            fastLineTiebreakerWinnerId = null;
            players = Array.from({ length: 4 }, (_, i) => ({
                id: i + 1, name: '', rounds: [false, false, false, false],
                fastLineCorrect: -1, fastLineIncorrect: -1, finalRoundCorrect: -1,
            }));

            document.getElementById('episodeTitle').value = '';
            document.getElementById('airDate').valueAsDate = new Date();
            document.querySelector('input[name="episodeNumber"][value="1"]').checked = true;

            document.querySelectorAll('.player-card').forEach(card => {
                card.querySelector('.player-name').value = '';
                card.querySelectorAll('.round-toggle.correct').forEach(btn => btn.classList.remove('correct'));
                card.querySelectorAll('.choice-btn.selected').forEach(btn => btn.classList.remove('selected'));
            });
            updateAllScores();
        }

        // --- SUBMISSION ---
        async function handleSubmit() {
            const submitBtn = document.getElementById('submitBtn');
            const submitMessage = document.getElementById('submitMessage');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            submitMessage.textContent = '';

            const airDate = document.getElementById('airDate').value;
            const episodeTitle = document.getElementById('episodeTitle').value;
            const episodeElement = document.querySelector('input[name="episodeNumber"]:checked');
            const episodeNumber = episodeElement ? episodeElement.value : null;

            if (!airDate || !episodeNumber || !episodeTitle) {
                submitMessage.textContent = 'Please fill out Title, Air Date and Episode Number.';
                submitMessage.className = 'text-red-400 mt-2 h-6';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Game Results';
                return;
            }

            updateAllScores();

            const gameData = {
                episodeTitle: episodeTitle,
                airDate: airDate,
                episodeNumber: parseInt(episodeNumber),
                roundTiebreakerWinnerId: roundTiebreakerWinnerId || null,
                fastLineTiebreakerWinnerId: fastLineTiebreakerWinnerId || null,
                players: players.map((p, i) => {
                   const scores = playerScores[i];
                   return {
                       podium: p.id,
                       name: p.name,
                       round1Correct: p.rounds[0],
                       round2Correct: p.rounds[1],
                       round3Correct: p.rounds[2],
                       round4Correct: p.rounds[3],
                       fastLineCorrect: p.fastLineCorrect === -1 ? null : p.fastLineCorrect,
                       fastLineIncorrect: p.fastLineIncorrect === -1 ? null : p.fastLineIncorrect,
                       finalRoundCorrect: p.finalRoundCorrect === -1 ? null : p.finalRoundCorrect,
                       scores: {
                           round1Score: Math.round(scores.round1),
                           round2Score: Math.round(scores.round2),
                           round3Score: Math.round(scores.round3),
                           round4Score: Math.round(scores.round4),
                           fastLineScore: Math.round(scores.fastLineScore),
                           finalTotal: Math.round(scores.final)
                       }
                   }
                })
            };

            console.log("Submitting this JSON payload:", JSON.stringify(gameData, null, 2));

            try {
                const response = await fetch('{% url "game_entry_api" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gameData),
                });

                if (response.ok) {
                    submitMessage.textContent = 'Success! Data submitted. Resetting form...';
                    submitMessage.className = 'text-green-400 mt-2 h-6';

                    setTimeout(() => {
                        resetForm();
                        submitMessage.textContent = '';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Game Results';
                    }, 2000);

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Server responded with status: ${response.status}`);
                }
            } catch (error) {
                console.error('Submission failed:', error);
                submitMessage.textContent = `Submission failed: ${error.message}`;
                submitMessage.className = 'text-red-400 mt-2 h-6';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Game Results';
            }
        }

        initialize();
    });
</script>
{% endblock %}

